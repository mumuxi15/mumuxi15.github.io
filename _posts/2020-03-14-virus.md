---
layout: post
title:  "Coronavirus Data Analysis"
date:   2020-03-14 19:07:19
preview: https://imgc.allpostersimages.com/img/print/u-g-Q10FX9I0.jpg?w=500&h=500&p=0
---
Title: COVID19 Spread Simulation using Python



Updates on 3.31

In New York, almost a month has passed since the start of the quarantine. In this time huge changes have occurred since I first started this blog in early February. My initial goal was to create a source that would collect total number of cases worldwide since the most updated information was not easily available to the public. However, the current situation has now changed, and there are more reliable resources that are documenting the spread of COVID-19 and disseminating the research in clear graphs. However, if you like to try my code, I have presensted it below (output is in json format).

```python
from bs4 import BeautifulSoup
from ast import literal_eval
import requests
import re, json
import pandas as pd


def get_text_bs(tree):
	""" extract data array from the charts 
		input: html
		output: dict
	"""
	body = tree.body
	if body is None:
		return None
	v = {}
	process_array = lambda sector : literal_eval(sector.split(':')[1].replace(' ',''))
	for tag in body.select('script'):
		if 'Highcharts.chart' in str(tag):
			tag = str(tag).replace('\n','').split('       ')
			for sector in tag:
				if 'categories' in sector and 'date' not in v.keys():
					v['date'] = process_array(sector)
				if 'text' in sector:
					title = sector
				if 'data' in sector:
					if 'Total Coronavirus Cases' in title:
						v['total'] = process_array(sector)
					elif 'Total Coronavirus Deaths' in title:
						v['death'] = process_array(sector)
					elif 'Total Coronavirus Currently Infected' in title:
						v['active'] = process_array(sector)
					else:
						continue
	return v
	

def download_virus_at(countries):
	r = {}
	for country in countries:
		url = 'https://www.worldometers.info/coronavirus/country/%s'%(country)
		response = requests.get(url)
		page = response.text
		soup = BeautifulSoup(page,"html5lib")
		r[country] = get_text_bs(soup)
		
	with open( 'virus_world.json', 'w') as f:
		json.dump(r, f)
	
"""add to COUNTRY if you want to include more,
   find country code on the worldmeters website
"""

COUNTRY = ['us','china','italy']	
download_virus_at(COUNTRY)
```



While coronavirus in China seems to be under control, here in US, the number of infected individuals are only beginning to drastically rise. As of March 31st, the number of confirmed cases in US on March 31st is about 188,530 and some officials predict up to [240,000 deaths](https://www.theguardian.com/world/2020/mar/31/donald-trump-coronavirus-briefing-painful-us-deaths)



<img src="https://live.staticflickr.com/65535/49726316521_3e2a294821_c.jpg" width="800" alt="corona_tot">

Figure 1 (a). Total confirmed cases in US, China, Italy                                             (b). Log scale



Figure 1 shows three countries at three phases of coronavirus. In China, the number of cases reached an almost stationary state at day 30 and since then has been under control. In Italy, the rate has slowed down and potentially may start to follow the trends of China (green line). In US, we are still at the growing stage, however, further calculations indicate that there is a slow-down sign at the tip of the blue line.Indicating, that we have a little hope. The log scale (Figure 1b) graph, shows that the US and China has a higher infection rate, which is indicative of high population density. The slope in figure 1b is obtained by breaking the data into smaller sections, and taking the maximum slope. Slope is calculated every 14 days using linear regression.



#### Analysis

Figure 1(a) shows that US data (blue line) probably follows an exponential trend ain the early stage, as also shown in the log Figure 1(b). Whereas, the green curve (China) looks more like a sigmoid function. So let's first try to predict the infection population **I(t)** with a simple exponential model, defining **I** as infection population with an assumption that each patient infects **A** number of new people every day. This can be tested by by plotting log(y) against t - Figure 1(b):  

$
\begin{equation} \label{0}
I = I_{0}\times A^{t}
\end{equation}
$

where t is number of days since $I_{0}$ cases. 

This model only fits the blue line, and does not fit the trend of the yellow or green line at later stage. After doing some research on spread of infectious diseases, it seems an SIR-model might be a better model. The model consists of three parts: infected population, susceptible population and recovered/immune population. As I am trying to model the total of confirmed cases, not the active cases, for simplicity I will I can drop the recovery aspect of the model. This greatly simplifies the math, allowing to simply solve an ordinary differential equation. To further simplify this, let's define population as 1 and **I(t)** is the percentage of population that is infected and **S(t)** is the proportion of susceptible population. Then we get:

$\begin{equation} \label{1}
S(t)+I(t) = 1
\end{equation}$


Define $\beta$  as  transmission rate. Upon further reflection, the rate of infection should be affected by both infection and susceptible population.  To consider two extreme cases, 
- when s = 1 , i = 0, the transmission rate, $\beta$ = 0
- when s = 0 , i = 1, everyone is infected and no more new cases, $\beta$ = 0 

 If we divide both side by $\delta t$, we can get: 

$\begin{equation} \label{2}
\frac{dI}{dt} = - \frac{dS}{dt} = \beta S I
\end{equation}$

This is equation is an ODE function, and we can solve it using scipy package. 

```python
from datetime import datetime, timedelta
from scipy.integrate import odeint
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
import requests
from helper import ODE_model

js = pd.read_json('virus_world.json')

def SI_model(c):
    v = np.array(js[c]['total'])
    v = v/(np.max(v)) # standardized
    y0 = v[0]

    t = np.linspace(0,50)

    # solve ODEs
    k1,k2,k3 = 0.1,0.3,0.5
    y1 = odeint(ODE_model,y0,t,args=(k1,))
    y2 = odeint(ODE_model,y0,t,args=(k2,))
    y3 = odeint(ODE_model,y0,t,args=(k3,))

    # plot results
    plt.plot(t,y1,'y:',linewidth=2,label='β=0.1')
    plt.plot(t,y2,'b:',linewidth=2,label='β=0.3')
    plt.plot(t,y3,'g:',linewidth=2,label='β=0.5')
    d = min(len(t),len(v))
    plt.plot(t[:d],v[:d],'r',linewidth=2,label=c)
    
    plt.xlabel('t')
    plt.ylabel('I(t)')
    plt.legend()
    plt.title('SI model fitting ')

    plt.show()
    
SI_model(c='china')


```

<img src="https://live.staticflickr.com/65535/49726837227_baf1f56d59_c.jpg" width="600" alt="testing">

In fact, turns out that this function $\begin{equation} \label{}
\frac{dI}{dt} = \beta I \cdot (1-I)
\end{equation}$  is the derivate of sigmoid function $\begin{equation} \label{}
I = \frac{1}{1+e^{-t}}
\end{equation}$



#### Prediction using sigmoid function

```python
from scipy.optimize import curve_fit
import json
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import requests
import time
 
def logistic_function(t, K, P0, r):
    'define logsitc function here, try yourself'
    return 
  
def prediction(c):
    predict_days = 30
    data = pd.read_json('data/virus_world.json')[c]
    confirm = np.array(data['total'])
    scaler = np.max(confirm)
    confirm = confirm/(scaler)
    
    x = np.arange(len(confirm))
    # curve fit
    popt, pcov = curve_fit(logistic_function, x, confirm,maxfev=2000)
    #predit future
    predict_x = list(x) + [x[-1] + i for i in range(1, 1 + predict_days)]
    predict_x = np.array(predict_x)
    predict_y = logistic_function(predict_x, popt[0], popt[1], popt[2])
    plt.figure(figsize=(8, 5))
    plt.plot(x, confirm, '^',label="confimed infected number")
    plt.plot(predict_x, predict_y, '--',label="predicted infected number")
    plt.xticks(rotation=90)
    plt.yticks(rotation=90)

    plt.suptitle("Coronavirus cases prediction in %s for the next %d days (Pred = %d,  r=%.2f)"%(c.capitalize(),predict_days,scaler*predict_y[-1], popt[2]), fontsize=12, fontweight="bold")
    plt.title("Predict time:{}".format(time.strftime("%Y-%m-%d", time.localtime())), fontsize=16)
    plt.xlabel('days', fontsize=14)
    plt.ylabel('Infected number', fontsize=14)
    plt.show()
    
prediction(c='china')
```



<p float="left">
<img src="https://live.staticflickr.com/65535/49726837247_fa301b48f3_c.jpg" width="50%" />  <img src="https://live.staticflickr.com/65535/49726837257_0b1c12643e_c.jpg" width="49%" />
 </p>



Thanks for reading !





Reference:

[Spread of Disease by Dr Julia Collins and Nadia Abdelal](https://calculate.org.au/wp-content/uploads/sites/15/2018/10/spread-of-disease.pdf)

[EMOD HIV modeling](https://idmod.org/docs/hiv/model-si.html)

